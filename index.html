<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UBL Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ubl-gradient {
            background: linear-gradient(135deg, #054166 0%, #249ACC 100%);
        }
        .ubl-border {
            border-color: #054166;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="ubl-gradient rounded-t-2xl shadow-xl p-6 text-white">
            <div class="flex items-center justify-center gap-3 mb-2">
                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                </svg>
                <h1 class="text-3xl font-bold">Attendance System</h1>
            </div>
            <p class="text-center text-blue-100 text-sm">L&D Department</p>
        </div>
        
        <div class="bg-white rounded-b-2xl shadow-xl p-8">
            <!-- Success Message -->
            <div id="successMsg" style="display: none;" class="mb-6 p-4 bg-blue-100 border-2 border-blue-600 rounded-lg text-blue-800 font-semibold text-center">
                ‚úî You're in! Have a productive day today!
            </div>
            
            <!-- Error Message -->
            <div id="errorMsg" style="display: none;" class="mb-6 p-4 bg-red-100 border-2 border-red-500 rounded-lg text-red-800 font-semibold text-center">
                ‚ùå <span id="errorText">Error occurred</span>
            </div>
            
            <div class="space-y-5">
                <!-- Cluster Selection -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üè¢ Select Cluster *</label>
                    <select id="cluster" class="w-full px-4 py-3 border-2 ubl-border rounded-lg text-lg focus:ring-2 focus:ring-blue-600">
                        <option value="">-- Select Cluster --</option>
                        <option value="South">South</option>
                        <option value="Central">Central</option>
                        <option value="North">North</option>
                    </select>
                </div>

                <!-- Employee Name -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üë§ Employee Name *</label>
                    <select id="employeeName" class="w-full px-4 py-3 border-2 ubl-border rounded-lg text-lg focus:ring-2 focus:ring-blue-600" disabled>
                        <option value="">-- Select Cluster First --</option>
                    </select>
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìä Attendance Status *</label>
                    <select id="status" class="w-full px-4 py-3 border-2 ubl-border rounded-lg text-lg focus:ring-2 focus:ring-blue-600">
                        <option value="">-- Select Status --</option>
                        <option value="Present" id="presentOption">Present</option>
                        <option value="Late">Late</option>
                        <option value="Personal/Sick Leave">Personal/Sick Leave</option>
                        <option value="Annual Leave">Annual Leave</option>
                    </select>
                    <p id="lateNotice" style="display: none;" class="mt-2 text-sm text-orange-600 font-semibold">‚è∞ It's past 9:00 AM - "Present" option is no longer available.</p>
                </div>

                <!-- Location -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìç Location *</label>
                    <button id="locationBtn" type="button" class="w-full ubl-gradient text-white px-6 py-4 rounded-lg text-lg font-bold hover:opacity-90 transition">
                        <span id="locationBtnText">Click to Get Location</span>
                    </button>
                    <div id="locationInfo" style="display: none;" class="mt-3 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                        <p class="text-sm font-semibold text-blue-800">‚úÖ Location Captured!</p>
                        <p class="text-sm mt-1"><strong>Coordinates:</strong> <span id="coords"></span></p>
                        <p class="text-sm"><strong>Address:</strong> <span id="addr"></span></p>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìù Notes (Optional)</label>
                    <textarea id="notes" class="w-full px-4 py-3 border-2 ubl-border rounded-lg focus:ring-2 focus:ring-blue-600" rows="3" placeholder="Any additional comments..."></textarea>
                </div>

                <!-- Submit Button -->
                <button id="submitBtn" class="w-full ubl-gradient text-white px-6 py-5 rounded-lg text-xl font-bold hover:opacity-90 transition mt-4">
                    <span id="submitText">‚úì Submit Attendance</span>
                </button>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="text-center mt-4 text-gray-600 text-sm">
            <p>¬© United Bank Limited - Attendance Management System</p>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw4blMS4G_mIhNLi2o_TUDo6dWwqaJ2c-Cb6BXiWzLu_0Mm-VLdiHv7QnsRjOsunDWc/exec';
        let locationData = null;

        // Check if device has already submitted today
        function hasSubmittedToday() {
            const lastSubmit = localStorage.getItem('lastSubmitDate');
            const today = new Date().toLocaleDateString('en-US');
            return lastSubmit === today;
        }

        // Lock the form if already submitted today
        function checkAndLockForm() {
            if (hasSubmittedToday()) {
                document.getElementById('cluster').disabled = true;
                document.getElementById('employeeName').disabled = true;
                document.getElementById('status').disabled = true;
                document.getElementById('locationBtn').disabled = true;
                document.getElementById('notes').disabled = true;
                document.getElementById('submitBtn').disabled = true;
                
                // Show locked message
                const errorMsg = document.getElementById('errorMsg');
                const errorText = document.getElementById('errorText');
                errorText.textContent = 'üîí Attendance already submitted from this device today. Please use a different device or try again tomorrow.';
                errorMsg.style.display = 'block';
                errorMsg.style.backgroundColor = '#FEF3C7';
                errorMsg.style.borderColor = '#F59E0B';
                errorMsg.querySelector('span').style.color = '#92400E';
                
                return true;
            }
            return false;
        }

        // Employee data by cluster
        const employees = {
            'South': [
                'Abdus Samad',
                'Aliza Khan',
                'Diana Vivian Dsouza',
                'Fouzia Aslam',
                'Jason Michael Clive Dsouza',
                'Muhammad Shaheer Ali Khan',
                'Nabeel ur Rehman',
                'Syed Ali Haider Mehdi',
                'Syeda Kanwal Sultana'
            ],
            'Central': [
                'Javed Hussain',
                'Khadija Adil',
                'Khawaja Fahad Tabish',
                'Nadia Batool',
                'Radiya Faysal',
                'Rizwan Hameed',
                'Sauood Sadiq'
            ],
            'North': [
                'Anjum Minhas',
                'Mubasher Iqbal',
                'Shahid Iqbal'
            ]
        };

        // Check form lock on page load
        window.onload = function() {
            checkAndLockForm();
            checkTimeForPresent();
        };

        // Check if it's past 9:02 AM Pakistan time and hide "Present" option
        function checkTimeForPresent() {
            // Get current time in Pakistan timezone (PKT = UTC+5)
            const now = new Date();
            const pakistanTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Karachi' }));
            const hours = pakistanTime.getHours();
            const minutes = pakistanTime.getMinutes();
            
            // Convert to total minutes since midnight for easy comparison
            const currentTotalMinutes = (hours * 60) + minutes;
            const cutoffTotalMinutes = (9 * 60) + 2; // 9:02 AM = 542 minutes
            
            // If time is 9:02 AM or later
            if (currentTotalMinutes >= cutoffTotalMinutes) {
                const presentOption = document.getElementById('presentOption');
                if (presentOption) {
                    presentOption.style.display = 'none';
                    presentOption.disabled = true;
                }
                document.getElementById('lateNotice').style.display = 'block';
            }
        }

        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
            setTimeout(() => {
                document.getElementById('errorMsg').style.display = 'none';
            }, 5000);
        }

        function showSuccess() {
            document.getElementById('successMsg').style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
            setTimeout(() => {
                document.getElementById('successMsg').style.display = 'none';
            }, 5000);
        }

        // Update employee dropdown based on cluster
        document.getElementById('cluster').addEventListener('change', function() {
            const cluster = this.value;
            const employeeSelect = document.getElementById('employeeName');
            const today = new Date().toLocaleDateString('en-US');
            
            employeeSelect.innerHTML = '<option value="">-- Select Your Name --</option>';
            
            if (cluster && employees[cluster]) {
                employeeSelect.disabled = false;
                
                employees[cluster].forEach(name => {
                    // Check if this person has already submitted today
                    const submissionKey = 'submitted_' + cluster + '_' + name + '_' + today;
                    const hasSubmitted = localStorage.getItem(submissionKey);

                    // Only add to dropdown if they haven't submitted
                    if (!hasSubmitted){
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        employeeSelect.appendChild(option);
                    }
                });
            } else {
                employeeSelect.disabled = true;
            }
        });
        
        document.getElementById('locationBtn').onclick = function() {
            const btn = this;
            const btnText = document.getElementById('locationBtnText');
            
            btnText.textContent = '‚è≥ Getting location...';
            btn.disabled = true;
            btn.style.opacity = '0.6';
            
            if (!navigator.geolocation) {
                showError('Your browser does not support location services');
                btnText.textContent = 'Click to Get Location';
                btn.disabled = false;
                btn.style.opacity = '1';
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    locationData = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    document.getElementById('coords').textContent = 
                        locationData.lat.toFixed(6) + ', ' + locationData.lng.toFixed(6);
                    
                    try {
                        const res = await fetch(
                            'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + 
                            locationData.lat + '&lon=' + locationData.lng
                        );
                        const data = await res.json();
                        locationData.address = data.display_name || 'Address not available';
                        document.getElementById('addr').textContent = locationData.address;
                    } catch (err) {
                        locationData.address = 'Could not fetch address';
                        document.getElementById('addr').textContent = locationData.address;
                    }
                    
                    document.getElementById('locationInfo').style.display = 'block';
                    btnText.textContent = '‚úÖ Location Captured';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                },
                function(error) {
                    showError('Could not get location. Please enable location permissions.');
                    btnText.textContent = 'Click to Get Location';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            );
        };

        document.getElementById('submitBtn').onclick = function() {
            const cluster = document.getElementById('cluster').value;
            const name = document.getElementById('employeeName').value;
            const status = document.getElementById('status').value;
            const notes = document.getElementById('notes').value;
            const submitBtn = this;
            const submitText = document.getElementById('submitText');
            
            if (!cluster) {
                showError('Please select a cluster');
                return;
            }
            if (!name) {
                showError('Please select your name');
                return;
            }
            if (!status) {
                showError('Please select status');
                return;
            }
            if (!locationData) {
                showError('Please capture your location first');
                return;
            }
            
            submitBtn.disabled = true;
            submitText.textContent = '‚è≥ Submitting...';
            submitBtn.style.opacity = '0.6';
            
            const now = new Date();
            const payload = {
                cluster: cluster,
                name: name,
                status: status,
                date: now.toLocaleDateString('en-US'),
                time: now.toLocaleTimeString('en-US'),
                latitude: locationData.lat,
                longitude: locationData.lng,
                address: locationData.address,
                notes: notes
            };
            
            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            
            .then(response => response.text())
            .then(data => {
                // Mark device as submitted for today
                const today = new Date().toLocaleDateString('en-US');
                localStorage.setItem('lastSubmitDate', today);

                // Mark this specific person as submitted for today
                const submissionKey = 'submitted_' + cluster + '_' + name + '_' + today;
                localStorage.setItem(submissionKey, 'true');
                
                // Show success message for 7 seconds
                document.getElementById('successMsg').style.display = 'block';
                document.getElementById('errorMsg').style.display = 'none';
                
                // After 7 seconds, lock the form and show the locked message
                setTimeout(() => {
                    document.getElementById('successMsg').style.display = 'none';
                    checkAndLockForm();
                }, 7000);
                
                // Re-enable button immediately (just hide it visually)
                submitBtn.disabled = false;
                submitText.textContent = '‚úì Submit Attendance';
                submitBtn.style.opacity = '1';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            })
            
            .catch(error => {
                console.error('Error:', error);
                showError('Failed to submit. Please try again.');
                submitBtn.disabled = false;
                submitText.textContent = '‚úì Submit Attendance';
                submitBtn.style.opacity = '1';
            });
        };
    </script>
</body>
</html>
